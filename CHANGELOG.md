# Changelog

All notable changes to the Finance Bro AI Stock Analysis application will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [Unreleased]

### Fixed
- [2025-07-26] **Dataframe Separation for AI Query Optimization**: Fixed PandasAI column detection issues by implementing dual dataframe architecture
  - **Issue**: PandasAI couldn't properly detect `Quarter` column because dataframes still contained `lengthReport` column names
  - **Root Cause**: Single dataframe set caused conflict between display formatting needs and AI query requirements
  - **Solution**: Implemented separate dataframe storage systems:
    - `st.session_state.display_dataframes`: Original dataframes with `lengthReport` for proper wide format display
    - `st.session_state.dataframes`: AI-optimized copies with `Quarter` column names for enhanced query compatibility
  - **AI Query Enhancement**: Renaming `lengthReport` ‚Üí `Quarter` provides semantic context that enables:
    - More intuitive natural language queries ("What's Q1 revenue?" vs "What's lengthReport 1 revenue?")
    - Better AI understanding of temporal relationships between quarters
    - Improved accuracy in quarterly trend analysis and comparisons
    - Enhanced contextual awareness for financial period-based calculations
  - **Display Integrity**: Wide format tables maintain original column structure for proper transposition logic
  - **Affected Components**: CashFlow, BalanceSheet, IncomeStatement, and Ratios dataframes for quarterly data

- [2025-07-26] **Show Table Button Error Handling**: Fixed AttributeError when clicking "Show Table" before loading data
  - **Issue**: `AttributeError: st.session_state has no attribute 'display_dataframes'` when no data loaded
  - **Solution**: Added proper existence checks and user-friendly warning messages
  - **User Experience**: Clear guidance to load data first before attempting to view tables

- [2025-07-26] **Display Logic Indentation**: Fixed multiple Python indentation errors in table display section
  - **Issue**: Syntax errors preventing proper code execution in wide format display logic
  - **Solution**: Corrected indentation throughout the display section for proper code structure
- [2025-01-25] Fixed sample questions functionality by moving from main content area to sidebar
- [2025-01-25] Resolved "ü§ñ Ask Question" button not working issue
- [2025-01-25] Fixed TypeError: object of type 'PandasConnector' has no len() by reverting to Agent approach
- [2025-01-25] Fixed multi-index Ratio dataframe processing for better AI analysis
- [2025-01-25] Fixed inconsistent generated code detection across different response methods
- [2025-01-25] Improved code visibility by implementing comprehensive code extraction logic

### Changed
- [2025-01-25] Moved sample questions from main content area (col3) to sidebar with dropdown menu
- [2025-01-25] Replaced individual question buttons with dropdown selection interface
- [2025-01-25] Relocated pending question processing logic from data loading section to AI Analysis section
- [2025-01-25] Simplified agent initialization by removing SmartDataframe approach

### Added
- [2025-01-25] Added dropdown menu for sample questions in sidebar
- [2025-01-25] Added spinner functionality for processing selected questions
- [2025-01-25] Added proper error handling for pending question processing
- [2025-01-25] Added multi-index column flattening for Ratio dataframe processing
- [2025-01-25] Added generated code display functionality for all AI responses
- [2025-01-25] Added expandable "üîç View Generated Code" containers under AI responses
- [2025-01-25] Added chart display containers with "üìà View Chart" expandable sections
- [2025-01-25] Added comprehensive code extraction helper function for better code detection

### Technical Details
- **Sample Questions UI**: Converted from expandable buttons in main area to dropdown selection in sidebar
- **Button Functionality**: Fixed issue where "Ask Question" button only worked during data loading
- **Agent Initialization**: Reverted from SmartDataframe to Agent class for better stability
- **Processing Logic**: Moved pending question processing to ensure agent availability
- **Ratio Data Processing**: Added multi-index column flattening to transform Vietnamese financial categories into readable column names
  - Example: `('Ch·ªâ ti√™u kh·∫£ nƒÉng sinh l·ª£i', 'ROE (%)')` ‚Üí `Ch·ªâ ti√™u kh·∫£ nƒÉng sinh l·ª£i - ROE (%)`
  - Preserves Meta columns (CP, NƒÉm, K·ª≥) with simple names
  - Enables better AI understanding of financial ratio categories
- **Generated Code Display**: Added transparency feature to show Python code generated by PandasAI
  - Uses official PandasAI API: `response.last_code_executed`
  - Displays code in expandable containers with syntax highlighting
  - Available for all AI response types: chat input, sidebar questions, quick buttons
  - Provides complete transparency into data analysis process
- **Chart Display Integration**: Added visual chart containers alongside generated code
  - Automatic chart detection from PandasAI exports/charts/ directory
  - Support for multiple chart formats: Plotly, Matplotlib, and image files
  - Expandable "üìà View Chart" containers positioned under code sections
- **Code Detection Enhancement**: Implemented robust code extraction system
  - Created `get_generated_code()` helper function for consistent code access
  - Tries multiple sources: response object, agent attributes, memory, internal state
  - Unified code detection across all response methods (chat, sidebar, quick buttons)
  - Improved reliability from inconsistent "Code generation details not available" messages

### User Experience Improvements
- ‚úÖ Sample questions now accessible from sidebar at all times
- ‚úÖ Cleaner main content area with sample questions removed from col3
- ‚úÖ Dropdown interface provides better organization of predefined questions
- ‚úÖ Spinner feedback shows processing status when analyzing selected questions
- ‚úÖ Questions are properly added to chat history with AI responses

### [2025-01-25] PandasAI Visualization Enhancements

#### Final Implementation
- **Chart Display**: Moved charts from expandable containers to direct display in main content area
- **Code Display**: Kept generated code in expandable "üîç View Generated Code" containers for clean interface
- **Layout**: Charts now appear directly below AI responses with proper subheaders
- **Consistency**: Applied same pattern across all response methods (chat, sidebar, quick buttons)

#### Technical Updates
- **Chat Interface**: Charts display directly in main content with "üìä Analysis Chart" subheader
- **Quick Buttons**: All three buttons (ROIC, Dividend Yield, Debt Analysis) now include chart detection
- **Sidebar Questions**: Pending questions include chart detection and display
- **Code Containers**: Generated code remains in expandable containers as requested

#### Visual Improvements
- **Immediate Visibility**: Charts appear directly without requiring user interaction
- **Clean Layout**: Generated code stays in expandable containers to avoid clutter
- **Consistent Design**: All AI response types follow the same display pattern
- **User Experience**: Better balance between transparency and clean interface

### [2025-01-25] Final Chart Display Fix
- **Sample Questions**: Fixed chart display for all sample questions (sidebar dropdown, quick buttons)
- **Chat Messages**: Updated chart display to show directly in main content area for all response types
- **Consistency**: All AI responses now follow same pattern - code in expandable containers, charts in main content

### [2025-01-25] Chart Clearing Enhancement
- **Chart Management**: Implemented automatic chart clearing before new questions
- **Text Preservation**: Previous text answers are preserved while charts are cleared
- **Single Chart Display**: Only the most recent chart is displayed at any time
- **User Experience**: Cleaner interface without chart accumulation
- **Implementation**: Charts are displayed only for the latest message in chat history
- **All Response Types**: Applied to chat input, sidebar questions, and quick buttons

## [2025-07-26] Financial Data Transformation Enhancement

### Fixed
- [2025-07-26] **Quarterly Data Transposition**: Fixed duplicate column names error when displaying quarterly financial data
  - Issue: When period="quarter" was selected, transposition failed with "Duplicate column names found" error
  - Root Cause: Only using `yearReport` as index created duplicates (2024, 2024, 2024, 2024 for Q1-Q4)
  - Solution: Combined `yearReport` and `lengthReport` to create unique quarterly identifiers (2024-Q1, 2024-Q2, etc.)
  - Affected: CashFlow, BalanceSheet, IncomeStatement, and Ratios dataframes

- [2025-07-26] **Period Parameter Handling**: Fixed dataframes not respecting user's period selection
  - Issue: Ratios dataframe showed quarterly headers even when period="year" was selected
  - Root Cause: Logic only checked for `lengthReport` column existence, not the actual period parameter
  - Solution: Added period parameter validation in transposition logic
  - Applied to: All financial dataframes (CashFlow, BalanceSheet, IncomeStatement, Ratios)

- [2025-07-26] **Automatic Data Reloading**: Implemented automatic data refresh when period changes
  - Issue: Changing period dropdown didn't reload data, causing stale data display
  - Root Cause: Data only loaded on "Analyze Stock" button click, not on period changes
  - Solution: Added period change detection with automatic data reloading
  - Benefit: Users no longer need to click "Analyze Stock" after changing period

- [2025-07-26] **Redundant Row Cleanup**: Removed meaningless rows from annual data display
  - Issue: `lengthReport` row showing value "5" when period="year" was confusing
  - Root Cause: API returns `lengthReport` column even for annual data
  - Solution: Drop `lengthReport` row for annual data since it's not meaningful
  - Applied to: Both financial statements and Ratios dataframes

### Added
- **Data Format Transformation**: Implemented automatic transposition of financial statements from long to wide format
- **Year Headers**: Financial metrics now display with years as column headers for easier trend analysis
- **Quarterly Support**: Added proper handling for quarterly data with quarter identifiers in column headers
- **Multi-format Support**: Added handling for different data structures including multi-index columns in Ratios
- **Smart Detection**: Automatic detection of data structure to apply appropriate transformation

### Technical Implementation
- **Financial Statements**: CashFlow, BalanceSheet, and IncomeStatement now transpose to wide format
  - Years promoted from `yearReport` column to column headers
  - Financial metrics displayed as row labels in "Metric" column
  - Ticker column dropped as redundant for display purposes
- **Ratios Handling**: Special processing for multi-index column structure
  - Detects if years are already in columns vs. need transposition
  - Handles flattened multi-index columns from Vietnamese financial data
  - Graceful fallback to original format when transposition fails
- **Dividends**: Maintained original format as time-series data is more appropriate

### User Experience Improvements
- **Trend Analysis**: Users can now easily compare financial metrics across years side-by-side
- **Standard Format**: Wide format aligns with traditional financial statement presentation
- **Error Handling**: Warning messages displayed if transposition fails for any dataset
- **Consistent Display**: All financial data follows the same wide format pattern

### Code Changes
- **Location**: Modified `üìä Show Raw Data` button functionality in app.py lines 483-520
- **Transformation Logic**: Added robust data structure detection and appropriate transposition methods
- **Fallback Support**: Maintains original display format when transformation is not possible
- **Data Integrity**: Preserves all original data while improving presentation format
